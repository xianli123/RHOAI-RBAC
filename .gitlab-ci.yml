# GitLab Pages for Node.js Web App
# Using GitLab Pages parallel deployments for branch previews
image: registry.redhat.io/ubi8/nodejs-18:latest

stages:
  - build
  - deploy

variables:
  NODE_ENV: production
  # Default prefix (overridden per branch in job rules)
  PAGES_PREFIX: "branch-$CI_COMMIT_BRANCH"

# Default settings for all jobs
default:
  tags:
    - shared-podman

build:
  stage: build
  script:
    - echo "Installing dependencies (including devDependencies for build tools)..."
    - npm ci --include=dev
    - echo "Setting up environment for build..."
    - export PATH="$PWD/node_modules/.bin:$PATH"
    - echo "Verifying build tools are available..."
    - which tsc || echo "TypeScript compiler not found - will use npx fallback"
    - echo "Running build process with PAGES_PREFIX=${PAGES_PREFIX}..."
    - npm run build
    - echo "GitLab Pages will use 404.html for SPA routing (already generated by webpack)"
    - echo "Not using _redirects to avoid conflicts with static assets"
    - ls -la dist/ | head -20
  artifacts:
    paths:
      - dist
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      # Main branch deploys to root (empty prefix)
      variables:
        PAGES_PREFIX: ""
    - if: $CI_COMMIT_BRANCH != "main"
      # Other branches use "branch-" prefix + branch slug as path prefix
      variables:
        PAGES_PREFIX: "branch-$CI_COMMIT_BRANCH"

# GitLab Pages deployment using parallel deployments feature
pages:
  stage: deploy
  dependencies:
    - build
  script:
    - echo "Pages deployment accessible at ${CI_PAGES_URL}"
    - |
      if [ -z "$PAGES_PREFIX" ]; then
        # Main branch: files at root
        mv dist public
        echo "Deployed to root"
      else
        # Other branches: create directory structure with branch prefix
        mkdir -p public/${PAGES_PREFIX}
        mv dist/* public/${PAGES_PREFIX}/
        echo "Deployed to /${PAGES_PREFIX}/"
      fi
    - echo "Contents of public/:"
    - find public -type f | head -20
  artifacts:
    paths:
      - public
  environment:
    name: pages/$CI_COMMIT_BRANCH
    url: $CI_PAGES_URL
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      # Main branch deploys to root (empty prefix)
      variables:
        PAGES_PREFIX: ""
    - if: $CI_COMMIT_BRANCH != "main"
      # Other branches use "branch-" prefix + branch slug as path prefix
      variables:
        PAGES_PREFIX: "branch-$CI_COMMIT_BRANCH"
