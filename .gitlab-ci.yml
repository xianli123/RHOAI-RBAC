# GitLab Pages for Static HTML
# Using GitLab Pages parallel deployments for branch previews
image: alpine:latest

stages:
  - deploy

variables:
  # Default prefix (overridden per branch in job rules)
  PAGES_PREFIX: "branch-$CI_COMMIT_BRANCH"

# Default settings for all jobs
default:
  tags:
    - shared-podman

# GitLab Pages deployment using parallel deployments feature
pages:
  stage: deploy
  script:
    - echo "Pages deployment accessible at ${CI_PAGES_URL}"
    - |
      if [ -z "$PAGES_PREFIX" ]; then
        # Main branch: files at root
        mkdir -p public
        cp index.html public/
        echo "Deployed to root"
      else
        # Other branches: create directory structure with branch prefix
        mkdir -p public/${PAGES_PREFIX}
        cp index.html public/${PAGES_PREFIX}/
        echo "Deployed to /${PAGES_PREFIX}/"
      fi
    - echo "Contents of public/:"
    - find public -type f
  artifacts:
    paths:
      - public
  environment:
    name: pages/$CI_COMMIT_BRANCH
    url: $CI_PAGES_URL
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      # Main branch deploys to root (empty prefix)
      variables:
        PAGES_PREFIX: ""
    - if: $CI_COMMIT_BRANCH != "main"
      # Other branches use "branch-" prefix + branch slug as path prefix
      variables:
        PAGES_PREFIX: "branch-$CI_COMMIT_BRANCH"
